<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Indian Culture Age-Based Quiz Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(120deg, #eecda3 0%, #ef629f 100%);
      min-height: 100vh;
      color: #1c1b1b;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
    }
    .container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 48px rgba(0,0,0,.10);
      padding: 36px 28px;
      width: 95%;
      max-width: 430px;
      text-align: center;
    }
    h1 {
      color: #e67e22;
      letter-spacing: 2px;
      margin-bottom: 16px;
    }
    p {
      font-size: 1.1rem;
      margin-bottom: 28px;
      color: #1a1a1a;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 12px;
      text-align: left;
      color: #444;
      letter-spacing: 0.5px;
    }
    select {
      padding: 8px 16px;
      font-size: 1rem;
      background: #fcf3e3;
      border: 1px solid #e1c699;
      border-radius: 6px;
      width: 100%;
      cursor: pointer;
      outline-offset: 2px;
      margin-bottom: 30px;
    }
    select:focus {
      border-color: #e67e22;
      outline: none;
      box-shadow: 0 0 6px #e67e22aa;
    }
    button {
      background: #e67e22;
      color: white;
      border: none;
      padding: 13px 38px;
      border-radius: 22px;
      font-size: 1rem;
      cursor: pointer;
      letter-spacing: 1.5px;
      font-weight: bold;
      width: 100%;
      transition: background 0.3s ease;
    }
    button:disabled {
      background: #f9dfa9;
      color: #bcbcbc;
      cursor: not-allowed;
    }
    button:not(:disabled):hover {
      background: #ef8f3c;
    }
    .quiz-section {
      display: none;
      text-align: center;
    }
    .quiz-section.active {
      display: block;
    }
    .progress {
      margin: 10px 0 26px;
      color: #555;
      font-size: 0.95rem;
    }
    .question {
      font-weight: 600;
      font-size: 1.15rem;
      margin-bottom: 22px;
      color: #1a1a1a;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 18px;
      max-width: 100%;
    }
    .options button {
      background: #eecda3;
      border: none;
      border-radius: 6px;
      padding: 14px 0;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s, color 0.3s;
      font-weight: 500;
      max-width: 100%;
    }
    .options button.correct {
      background: #7dcc7d !important;
      color: #fff;
      cursor: default;
    }
    .options button.wrong {
      background: #e57373 !important;
      color: #fff;
      cursor: default;
    }
    .options button:hover:not(.correct):not(.wrong) {
      background: #ef629f;
      color: #fff;
    }
    .next-btn {
      margin-top: 8px;
    }
    .result-score {
      font-size: 1.3rem;
      margin: 28px 0 0 0;
      color: #ef629f;
      font-weight: 600;
    }
    .encouragement {
      font-size: 1.5rem;
      margin-top: 8px;
      color: #ff7b00;
    }
    @media (max-width: 500px) {
      .container {
        padding: 20px 8px;
      }
      h1 {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>

  <div class="container" id="introScreen">
    <h1>Welcome to Indian Culture Quiz</h1>
    <p>Test your knowledge about India's rich heritage, festivals, famous places, and arts.</p>
    <label for="ageGroupSelect">Select Your Age Group:</label>
    <select id="ageGroupSelect" aria-label="Select your age group">
      <option value="" selected disabled>Choose age group</option>
      <option value="kids">Kids (below 15)</option>
      <option value="teens">Teens (15-19)</option>
      <option value="adults">Adults (20+)</option>
    </select>
    <button id="startButton" disabled>Start Quiz</button>
  </div>

  <div class="container quiz-section" id="quizSection">
    <div class="progress" id="progress"></div>
    <div class="question" id="question"></div>
    <div class="options" id="options"></div>
    <button class="next-btn" id="nextButton" disabled>Next</button>
    <div class="result-score" id="result" style="display:none;"></div>
    <div class="encouragement" id="encouragement" style="display:none;"></div>
  </div>

<script>
  const introScreen = document.getElementById('introScreen');
const quizSection = document.getElementById('quizSection');
const ageGroupSelect = document.getElementById('ageGroupSelect');
const startButton = document.getElementById('startButton');
const progress = document.getElementById('progress');
const questionBox = document.getElementById('question');
const optionsBox = document.getElementById('options');
const nextButton = document.getElementById('nextButton');
const resultBox = document.getElementById('result');
const encouragementBox = document.getElementById('encouragement');

let selectedAge = "";
let current = 0;
let score = 0;
let questions = [];

// Fallback questions for when OpenAI is unavailable
const fallbackQuestions = {
  kids: [
    {
      q: "What is the national bird of India?",
      options: ["Peacock", "Eagle", "Parrot", "Crow"],
      answer: 0
    },
    {
      q: "Which festival is known as the Festival of Lights?",
      options: ["Holi", "Diwali", "Eid", "Christmas"],
      answer: 1
    },
    {
      q: "What is the capital of India?",
      options: ["Mumbai", "Chennai", "New Delhi", "Kolkata"],
      answer: 2
    },
    {
      q: "Which monument is known as a symbol of love?",
      options: ["Red Fort", "Taj Mahal", "India Gate", "Qutub Minar"],
      answer: 1
    },
    {
      q: "What is the national flower of India?",
      options: ["Rose", "Jasmine", "Lotus", "Sunflower"],
      answer: 2
    }
  ],
  teens: [
    {
      q: "Who wrote the Indian national anthem 'Jana Gana Mana'?",
      options: ["Mahatma Gandhi", "Rabindranath Tagore", "Subhas Chandra Bose", "Jawaharlal Nehru"],
      answer: 1
    },
    {
      q: "Which classical dance form originated in Tamil Nadu?",
      options: ["Kathak", "Bharatanatyam", "Odissi", "Manipuri"],
      answer: 1
    },
    {
      q: "The ancient university of Nalanda was located in which state?",
      options: ["Uttar Pradesh", "West Bengal", "Bihar", "Odisha"],
      answer: 2
    },
    {
      q: "Which Mughal emperor built the Taj Mahal?",
      options: ["Akbar", "Shah Jahan", "Aurangzeb", "Humayun"],
      answer: 1
    },
    {
      q: "What is the traditional art of henna painting called?",
      options: ["Rangoli", "Mehendi", "Warli", "Madhubani"],
      answer: 1
    }
  ],
  adults: [
    {
      q: "Which Indus Valley Civilization site is located in Gujarat?",
      options: ["Harappa", "Mohenjo-daro", "Dholavira", "Kalibangan"],
      answer: 2
    },
    {
      q: "The Ajanta and Ellora caves are located in which state?",
      options: ["Madhya Pradesh", "Maharashtra", "Karnataka", "Rajasthan"],
      answer: 1
    },
    {
      q: "Which raga is traditionally performed in the early morning?",
      options: ["Yaman", "Bhairav", "Malkauns", "Darbari"],
      answer: 1
    },
    {
      q: "The Konark Sun Temple was built during which dynasty?",
      options: ["Chola", "Pallava", "Eastern Ganga", "Hoysala"],
      answer: 2
    },
    {
      q: "Which ancient text contains the principles of Indian architecture?",
      options: ["Arthashastra", "Natya Shastra", "Vastu Shastra", "Dharma Shastra"],
      answer: 2
    }
  ]
};

async function fetchQuizQuestions(selectedAge) {
  try {
    // First check if backend is running
    const healthResponse = await fetch("http://localhost:4000/health");
    if (!healthResponse.ok) {
      throw new Error("Backend server not responding");
    }
    
    const response = await fetch("http://localhost:4000/quiz", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ ageGroup: selectedAge }),
      timeout: 35000 // 35 second timeout
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      if (errorData.fallback) {
        console.log("Using fallback questions due to OpenAI service issues");
        return fallbackQuestions[selectedAge] || fallbackQuestions.kids;
      }
      throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    // Defensive in case backend fails
    if (!data.questions || !Array.isArray(data.questions)) {
      throw new Error("Invalid response format");
    }
    
    return data.questions;
  } catch (error) {
    console.error('Error fetching quiz questions:', error);
    
    // Use fallback questions when Gemini API fails
    console.log("Using fallback questions due to Gemini API issues");
    alert("Using offline questions due to API connection issues. Quiz will still work!");
    return fallbackQuestions[selectedAge] || fallbackQuestions.kids;
  }
}

ageGroupSelect.addEventListener('change', () => {
  startButton.disabled = (ageGroupSelect.value === "");
});

startButton.addEventListener('click', async () => {
  selectedAge = ageGroupSelect.value;
  current = 0;
  score = 0;
  resultBox.style.display = "none";
  encouragementBox.style.display = "none";
  introScreen.style.display = "none";
  quizSection.style.display = "block";
  nextButton.disabled = true;
  
  // Fetch questions from backend
  questions = await fetchQuizQuestions(selectedAge);
  if (questions.length === 0) return; // Fetch failed
  
  showQuestion();
});

function showQuestion() {
  if (current >= questions.length) {
    showResult();
    return;
  }
  progress.textContent = `Question ${current + 1} of ${questions.length}`;
  questionBox.textContent = questions[current].q;
  optionsBox.innerHTML = '';
  questions[current].options.forEach((opt, idx) => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.onclick = () => selectOption(btn, idx);
    optionsBox.appendChild(btn);
  });
  nextButton.disabled = true;
  nextButton.style.display = "inline-block";
  nextButton.textContent = (current < questions.length - 1) ? "Next" : "Finish";
}

function selectOption(btn, idx) {
  [...optionsBox.children].forEach(b => b.disabled = true);
  if (idx === questions[current].answer) {
    btn.classList.add('correct');
    score++;
  } else {
    btn.classList.add('wrong');
    optionsBox.children[questions[current].answer].classList.add('correct');
  }
  nextButton.disabled = false;
}

nextButton.addEventListener('click', () => {
  current++;
  showQuestion();
});

function showResult() {
  questionBox.textContent = '';
  optionsBox.innerHTML = '';
  progress.textContent = '';
  resultBox.style.display = "block";
  encouragementBox.style.display = "block";
  resultBox.textContent = `You scored ${score} out of ${questions.length}!`;
  nextButton.disabled = true;
  nextButton.style.display = 'none';

  if(score === questions.length) {
    encouragementBox.textContent = "üéâ Fantastic! You got a perfect score! üëèüëèüëè";
  } else if(score >= questions.length / 2) {
    encouragementBox.textContent = "üëç Great job! Keep learning! üëè";
  } else {
    encouragementBox.textContent = "üòä Keep trying ‚Äì you‚Äôre getting there!";
  }
}

quizSection.style.display = "none";

</script>

</body>
</html>
